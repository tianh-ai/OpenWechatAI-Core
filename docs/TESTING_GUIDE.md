# 微信通信测试指南

## 测试脚本说明

### 1. 基础消息发送测试 (`test_send_message.py`)

**功能**：测试消息发送的基本功能

**测试模式**：
- 模式1：完整流程测试（发送3条消息）
- 模式2：交互式发送（手动输入消息）
- 模式3：边界情况测试（特殊字符、长文本、表情等）
- 模式4：快速单条测试 ✅ **已通过**

**运行方法**：
```bash
python examples/test_send_message.py
# 然后选择测试模式 1-4
```

**测试结果**：
- ✅ 启动微信
- ✅ 打开聊天窗口
- ✅ 点击输入框
- ✅ 输入文本
- ✅ 点击发送按钮
- ✅ 返回聊天列表

**生成截图**：
```
screenshots/send_test/
├── 01_wechat_list_*.jpg      # 微信列表
├── 02_chat_opened_*.jpg       # 聊天窗口
├── 03_input_focused_*.jpg     # 输入框聚焦
├── 04_text_inputted_*.jpg     # 文本已输入
├── 05_message_sent_*.jpg      # 消息已发送
└── 06_back_to_list_*.jpg      # 返回列表
```

---

### 2. 完整通信测试 (`test_communication.py`)

**功能**：测试发送、接收、自动回复的完整流程

**测试模式**：
1. **基本发送测试** - 快速发送3条消息
2. **发送并等待回复** - 发送消息后等待手动回复
3. **自动回复测试** - 检测到消息后自动回复
4. **持续监控模式** - 持续监控并自动回复所有消息
5. **运行所有测试** - 依次运行测试1-3

**运行方法**：
```bash
python examples/test_communication.py
# 然后选择测试模式 1-5
```

**测试1：基本发送**
```bash
# 选择 1
# 自动发送3条测试消息
# 完全自动化，无需手动操作
```

**测试2：发送并等待回复**
```bash
# 选择 2
# 脚本发送消息后，手动在手机上回复
# 脚本会检测到回复并提示
```

**测试3：自动回复**
```bash
# 选择 3
# 脚本发送消息并等待回复
# 收到回复后自动发送回复消息
```

**测试4：持续监控**
```bash
# 选择 4
# 持续监控新消息
# 每收到一条消息自动回复
# 按 Ctrl+C 停止
```

---

## 测试准备

### 前置条件
1. ✅ 手机已连接并配置完成
2. ✅ 微信已登录
3. ✅ 至少有一个聊天窗口

### 测试前检查
```bash
# 检查手机连接
./scripts/check-phone.sh

# 检查微信是否运行
adb shell dumpsys window | grep -i wechat
```

---

## 测试流程

### 快速测试（2分钟）
```bash
# 1. 快速发送单条消息
python examples/test_send_message.py
# 选择 4

# 查看截图验证
ls -lh screenshots/send_test/
```

### 完整测试（5分钟）
```bash
# 2. 完整流程测试
python examples/test_send_message.py
# 选择 1

# 查看结果
cat screenshots/send_test/*.jpg
```

### 交互测试（按需）
```bash
# 3. 交互式发送
python examples/test_send_message.py
# 选择 2
# 手动输入消息测试
```

### 自动回复测试（需要手动配合）
```bash
# 4. 自动回复
python examples/test_communication.py
# 选择 3
# 按提示在手机上发送消息
```

---

## 测试验证

### 成功标志
1. **发送成功**
   - 截图中看到消息出现在聊天窗口
   - 输入框已清空
   - 消息显示在右侧（已发送状态）

2. **接收成功**
   - 脚本检测到界面变化
   - 日志显示 "检测到新消息"
   - 生成了 reply_received 截图

3. **自动回复成功**
   - 收到消息后自动发送回复
   - 回复消息出现在聊天窗口
   - 日志显示发送和接收计数

### 失败排查

#### 消息未发送
**可能原因**：
- 输入框坐标不准确
- 发送按钮坐标错误
- 键盘遮挡了发送按钮

**解决方案**：
```python
# 调整坐标
input_y = int(self.height * 0.92)  # 尝试 0.90, 0.91, 0.93
send_x = int(self.width * 0.95)    # 尝试 0.92, 0.93, 0.96
```

#### 未检测到回复
**可能原因**：
- 图像对比阈值太高
- 检查间隔太长
- 截图区域不准确

**解决方案**：
```python
# 降低阈值
threshold = 0.03  # 从 0.05 降低到 0.03

# 缩短间隔
check_interval = 1  # 从 2 秒改为 1 秒
```

---

## 坐标调试

### 查看当前坐标
```python
# 在脚本中添加调试输出
print(f"输入框: ({input_x}, {input_y})")
print(f"发送按钮: ({send_x}, {send_y})")
```

### 手动测试坐标
```python
import uiautomator2 as u2
d = u2.connect()

# 测试点击位置
d.click(540, 2208)  # 输入框
d.click(1026, 2208) # 发送按钮
```

### 不同分辨率调整

| 分辨率 | 输入框Y | 发送按钮X |
|--------|---------|-----------|
| 1080x2400 | 2208 (92%) | 1026 (95%) |
| 1080x2340 | 2153 (92%) | 1026 (95%) |
| 1440x3200 | 2944 (92%) | 1368 (95%) |

---

## 进阶测试

### 1. 批量发送测试
```python
# 修改 test_send_message.py
messages = [f"测试消息 {i}" for i in range(10)]
sender.send_multiple_messages(messages)
```

### 2. 定时发送测试
```python
import schedule

def send_periodic():
    sender.send_message(f"定时消息 - {datetime.now()}")

schedule.every(10).seconds.do(send_periodic)
```

### 3. 条件回复测试
```python
def smart_reply(received_msg):
    if "你好" in received_msg:
        return "你好！有什么可以帮助你的吗？"
    elif "时间" in received_msg:
        return f"现在是 {datetime.now().strftime('%H:%M')}"
    else:
        return "收到消息"
```

---

## 测试记录

### 测试1：快速单条发送
- **日期**: 2025-12-16 18:32
- **设备**: Redmi 24094RAD4C
- **结果**: ✅ 成功
- **耗时**: 10秒
- **截图**: 6张
- **备注**: 所有步骤正常，消息成功发送

### 测试2：完整流程
- **状态**: ⏳ 待测试

### 测试3：自动回复
- **状态**: ⏳ 待测试

---

## 常见问题

### Q: 消息发送后看不到？
**A**: 检查聊天窗口是否正确打开，查看截图 `02_chat_opened`

### Q: 输入框点击无反应？
**A**: 可能键盘已经打开，尝试调整 `input_y` 坐标

### Q: 自动回复不工作？
**A**: 检查消息检测阈值，降低 `threshold` 参数

### Q: 如何调试坐标？
**A**: 在每次点击后添加截图，查看实际点击位置

---

## 下一步优化

1. **OCR集成** - 识别消息内容
2. **智能回复** - 基于内容的条件回复
3. **群聊支持** - 处理群消息
4. **消息队列** - 批量处理消息
5. **错误恢复** - 自动重试机制

---

**更新时间**: 2025-12-16 18:35  
**测试版本**: v0.6.0-alpha  
**测试状态**: 基础发送 ✅ | 完整流程 ⏳ | 自动回复 ⏳
